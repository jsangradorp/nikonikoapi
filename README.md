# Nikoniko API

An API to manage a collection of nikoniko calendars.

See current spec in `docs/` directory: [OpenAPI format](docs/spec/openapi.yaml), or [automatically generated by Hug](docs/nikoniko.json)

[HUG framework](http://www.hug.rest/) is used for the API.
[SQLAlchemy](https://www.sqlalchemy.org/) and
[Marshmallow](https://github.com/marshmallow-code/marshmallow) are used as ORM.

Python 3 mandatory.

## Running

3 ways to run more or less out of the box:

- Local:

`LOCAL="y" JWT_SECRET_KEY="example-local-jwt-key" ./scripts/run.sh`

- Docker:

`docker-compose up`

- External host (for example, virtual machine):
`./scripts/deploy.sh [IP address of the host]`

Since this uses [cdist](https://www.nico.schottelius.org/software/cdist/) for
deployment, you need to be able to ssh passwordless as root to the destination
host for this to work.

## Environment variables affecting runtime

See a list of environment variables and default values in
`conf/etc/default/nikonikoapi.sample`

## Secret files and how to generate them

- server certificate and key (`localhost.crt` and `localhost.key` **only for
  development**):

  `openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout conf/etc/nginx/localhost.key -out conf/etc/nginx/localhost.crt -subj "/CN=example.com" -days 3650`

See also for example [this entry in Stack Overflow](https://stackoverflow.com/questions/10175812/how-to-create-a-self-signed-certificate-with-openssl/41366949#41366949).

- `dhparams.pem`

  `openssl dhparam -out dhparams.pem 2048`

### Bootstrapping a test DB

If the `DO_BOOSTRAP_DB` environment variable is set to `y`, example values
will be inserted in the DB on startup.

- To run locally, adapt and use `scripts/run.sh`. You will need a postgresql
  installation.
- Alternatively, just run `docker-compose up`.
- To deploy to a debian stretch, use the `scripts/deploy.sh` script. It will
  not run correctly if you don't add `cdist` `tags` to the hosts you want to
  deploy to.
